@page "/Data/ProjectMemberAssignAwarded/{id:int}"

@using Data;
@using ModelM2s;
@using ModelM4s;

@inject ProjectData pj;
@inject NavigationManager NavManager

<h3>Project Sub Detail</h3>
<br />
@if (awarded.Id > 0)
{
    <p font-size:25px> <b>Project Sub Running Number :</b> @awarded.ProjectSubProjectTl.ProjectSubRunNo  </p>
    <p font-size:25px> <b>Project Sub Name :</b> @awarded.ProjectSubProjectTl.ProjectSubName  </p>
    <p font-size:25px> <b>Description :</b> @awarded.ProjectSubProjectTl.Description  </p>
    <p font-size:25px> <b>Remarked :</b> @awarded.ProjectSubProjectTl.Remark </p>

    @if (string.IsNullOrEmpty(awarded.ProjectSubProjectTl.Budget.ToString()))
    {
        <p font-size:25px> <b>Budget :</b> 0 THB</p>
    }
    else
    {
        <p font-size:25px> <b>Budget :</b> @awarded.ProjectSubProjectTl.Budget THB</p>
    }

    <p font-size:25px> <b>Status :</b> @awarded.ProjectSubProjectTl.ProjectSubStatus</p>

    @if (string.IsNullOrEmpty(awarded.ProjectSubProjectTl.PlanStartDate.ToString()))
    {
        <p font-size:25px> <b>Started Date :</b> Not Planed</p>
    }
    else
    {
        <p font-size:25px> <b>Started Date :</b> @awarded.ProjectSubProjectTl.PlanStartDate</p>
    }

    @if (string.IsNullOrEmpty(awarded.ProjectSubProjectTl.PlanFinishDate.ToString()))
    {
        <p font-size:25px> <b>Finished Date :</b> Not Planed</p>
    }
    else
    {
        <p font-size:25px> <b>Finished Date :</b> @awarded.ProjectSubProjectTl.PlanFinishDate</p>
    }
}

<br />
<br />
<br />
<h3>Member Assignment</h3>
<br />

@if(awarded.MemberId > 0)
{
    var item = member.Where(w => w.Id == awarded.MemberId).FirstOrDefault();
    <p>
        &nbsp; Company Name TH: @item.CompanyNameTh <br />
        &nbsp; Company Name EN : @item.CompanyNameEn <br />
        &nbsp; Telephone : @item.Telephone <br />
        &nbsp; Email : @item.Email <br />
        &nbsp; Website : @item.WebSite <br />
        &nbsp; Facebook : @item.Facebook <br />
    </p>
}
@if (awarded.Awarded == "Y")
{

}
else
{
    <br />
    <p>Is Awarded ?</p>
    <br />
    <button @onclick="()=>UpdateAwarded()">Yes</button>
    <button @onclick="()=>GoBack()">No</button>
}

<br />
<br />



@code {
    [Parameter]
    public int id { get; set; }

    public ProjectSubMemberAsgmt awarded { get; set; } = new ProjectSubMemberAsgmt();
    public ProjectSubProjectTl projectsub { get; set; } = new ProjectSubProjectTl();
    public ProjectHd projecthd { get; set; } = new ProjectHd();
    private List<MemberMaster> member;


    protected override async Task OnInitializedAsync()
    {
        await Initial();
    }
    private async Task Initial()
    {
        awarded = await pj.GetMemberAssign(id);
        member = await pj.GetAllMember();
        StateHasChanged();
    }

    async void UpdateAwarded()
    {
        int hiscount = awarded.MemberAsgmtawardedHistories.Count;
        if (hiscount < 1)
        {
            awarded.Awarded = "Y";
            awarded.ProjectSubProjectTl.ProjectSubStatus = "Member Assignments Awarded";
            awarded.MemberAsgmtawardedHistories.Add(new MemberAsgmtawardedHistory() { MemberAssignmentId = awarded.MemberId, DateAwarded = DateTime.Now, Active = "Y", LastUpdated = DateTime.Now, EditorId = 1 });
            awarded.ProjectSubProjectTl.ProjectSubProjectTlhistories.Add(new ProjectSubProjectTlhistory() { ProjectSubProjectTlid = awarded.ProjectSubProjectTlid, Remark = "Member Assignments Awarded", EditorId = 1 });
            var result = await pj.SaveMemberAssign(awarded);

            NavManager.NavigateTo("/Data/MemberAssign/" + awarded.ProjectSubProjectTlid.ToString());
        }
    }

    async void UpdateProjectHD()
    {
        projectsub = await pj.GetProjectSubProjectTLbyID(awarded.ProjectSubProjectTlid);
        projecthd = await pj.GetProjectHDbyID(projectsub.ProjectHdid);
        int subcount = projecthd.ProjectSubProjectTls.Count;
        int award = 0;
        foreach (var list in projecthd.ProjectSubProjectTls)
        {
            if (list.ProjectSubStatus == "Member Assignments Awarded") award++;
        }

        if (subcount == award)
        {
            projecthd.ProjectHdhistories.Add(new ProjectHdhistory() { ProjectHdid = projecthd.Id, Remark = "Member Assignments Awarded", TimeStamp = DateTime.Now, EditorId = 1 });
            projecthd.ProjectHdstatus = "Member Assignments Awarded";
            var result = await pj.SaveProjectHD(projecthd);
            NavManager.NavigateTo("/Data/MemberAssign/" + awarded.ProjectSubProjectTlid.ToString());
        }
    }

    private void GoBack()
    {
        NavManager.NavigateTo("/Data/MemberAssign/" + awarded.ProjectSubProjectTlid.ToString());
    }

}
