@page "/Data/ProjectEdit/{id:int}"

@implements IDisposable;

@using ModelM2s;
@using ModelM4s;
@using Data;
@using System.IO;
@using Radzen;
@using Radzen.Blazor;
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization

@inject IWebHostEnvironment env
@inject ProjectData pj;
@inject NavigationManager NavManager
@inject DialogService DialogService

<br />
<h3>Edit Project</h3>
<EditForm Model="projecthd">
    <ConcurrentComponent ModuleName="ProjectEdit" ObjId="projecthd.Id" UserId="userid"></ConcurrentComponent>

    <RadzenFieldset Text="Project Main">
        <div class="container">
            <div class="row">
                <div class="col-2"><p><b>Main Project Name</b></p></div>
                <div class="col"><InputText style="width: 100%" id="MainName" @bind-Value="projecthd.ProjectName"></InputText></div>
            </div>
            <div class="row">
                <div class="col-2"><p><b>Description</b></p></div>
                <div class="col"><RadzenTextArea Style="width:100%" @bind-Value=@projecthd.Description Cols="30" Rows="3" /></div>
            </div>
            <div class="row">
                <div class="col-2"><p><b>Remark</b></p></div>
                <div class="col"><RadzenTextArea Style="width:100%" @bind-Value=@projecthd.Remark Cols="30" Rows="3" /></div>
            </div>
            <div class="row">
                <div class="col-2"><p><b>Budget</b></p></div>
                <div class="col"><InputNumber style="width: 100%" id="MainBudget" @bind-Value="projecthd.Budget"></InputNumber></div>
                <div class="col-1">THB</div>
            </div>
            <div class="row">
                <div class="col-2"><p><b>Started Date</b></p></div>
                <div class="col-2">
                    <p>
                        <RadzenDatePicker @bind-Value=@projecthd.PlanStartDate DateFormat="dd/MM/yyyy" Class="w-100">
                            <FooterTemplate>
                                <RadzenButton Click=@OnTodayPlanStart Text="Today" Class="my-3 w-100" />
                            </FooterTemplate>
                        </RadzenDatePicker>
                    </p>
                </div>
            </div>
            <div class="row">
                <div class="col-2"><p><b>Finished Date</b></p></div>
                <div class="col-2">
                    <p>
                        <RadzenDatePicker @bind-Value=@projecthd.PlanFinishDate DateFormat="dd/MM/yyyy" Class="w-100">
                            <FooterTemplate>
                                <RadzenButton Click=@OnTodayPlanFinish Text="Today" Class="my-3 w-100" />
                            </FooterTemplate>
                        </RadzenDatePicker>
                    </p>
                </div>
            </div>
        </div>
    </RadzenFieldset>
    <br />

    <RadzenFieldset Text="Customer">
        <div class="container">
            <div class="row">
                <div class="col-2"><p><b>Old Customer</b></p></div>
                @if (customer is not null)
                {
                    var cust = customer[0];
                    <div class="col">@cust.CompanyName</div>
                }
            </div>
            <div class="row">
                <div class="col-2"><p><b>New Customer</b></p></div>
                <div class="col">
                    <RadzenAutoComplete Placeholder="Select a customer..." Data=@custommember TextProperty="CompanyNameEn"
                                        LoadData=@OnLoadData Style="width: 100%;" Change=@(args => GetMemberID(args)) />
                </div>
            </div>
            <br />
            <div class="row">
                @if (listcontact is not null)
                {
                    foreach (var list in listcontact)
                    {
                        <p>
                            <RadzenCard class="rz-background-color-info-lighter">
                                <div class="row">
                                    <div class="col-2"><b>Name</b></div>
                                    <div class="col">@list.Name</div>
                                    <div class="col-1"><RadzenButton Click=@(args => listcontact.Remove(list)) Text="X" ButtonStyle="ButtonStyle.Danger" /></div>
                                </div>
                                <div class="row">
                                    <div class="col-2"><b>Position</b></div>
                                    <div class="col">@list.Position</div>
                                </div>
                                <div class="row">
                                    <div class="col-2"><b>Address</b></div>
                                    <div class="col"><a style="white-space: pre-wrap;">@list.Address</a></div>
                                </div>
                                <div class="row">
                                    <div class="col-2"><b>Email</b></div>
                                    <div class="col">@list.Email</div>
                                </div>
                                <div class="row">
                                    <div class="col-2"><b>MobileNo</b></div>
                                    <div class="col">@list.MobileNo</div>
                                </div>
                                <div class="row">
                                    <div class="col-2"><b>Other</b></div>
                                    <div class="col"><a style="white-space: pre-wrap;">@list.Other</a></div>
                                </div>
                            </RadzenCard>
                        </p>
                    }
                }
            </div>
            <br />

            <RadzenCard class="rz-background-color-base-100">
                <div class="row">
                     <div class="row">
                        <div class="col-2"><b>Name</b></div>
                        <div class="col"><InputText style="width: 100%" id="MainName" @bind-Value="contactname" /></div>
                    </div>
                    <div class="row">
                         <div class="col-2"><b>Position</b></div>
                         <div class="col"><InputText style="width: 100%" @bind-Value="contactpos" /></div>
                    </div>
                    <div class="row">
                        <div class="col-2"><b>Address</b></div>
                        <div class="col"><RadzenTextArea style="width: 100%" @bind-Value="contactaddr" Cols="30" Rows="3" /></div>
                    </div>
                    <div class="row">
                        <div class="col-2"><b>Email</b></div>
                        <div class="col"><InputText style="width: 100%" @bind-Value="contactemail" /></div>
                    </div>
                    <div class="row">
                        <div class="col-2"><b>MobileNo</b></div>
                        <div class="col"><InputText style="width: 100%" @bind-Value="contactmobile" /></div>
                    </div>
                    <div class="row">
                        <div class="col-2"><b>Other</b></div>
                        <div class="col"><RadzenTextArea style="width: 100%" @bind-Value="contactother" Cols="30" Rows="3" /></div>
                    </div>
                    <div class="row-cols-sm-auto">
                        <RadzenButton Click=@(args => SaveContact()) Icon="add" Text="Add Contact" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Medium" />
                    </div>
                </div>
                
            </RadzenCard>
            <br />
            <div class="row">
                    <div class="col-1">
                        <RadzenButton Click=@(args => UpdateProjectHD()) Icon="update" Text="Update" ButtonStyle="ButtonStyle.Success" />
                    </div>
                </div>
        </div>
    </RadzenFieldset>
</EditForm>
<br />

@code {
    [Parameter]
    public int id { get; set; }

    public ProjectHd projecthd { get; set; } = new ProjectHd();
    private List<Customer> customer;
    private List<Customer> custommember;
    private List<CustomContact> listcontact;

    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; }

    private ClaimsPrincipal AuthenticationStateUser { get; set; }

    int userrole;
    string usermemberno;
    int userid;

    int customerid;

    string contactname;
    string contactpos;
    string contactaddr;
    string contactemail;
    string contactmobile;
    string contactother;

    protected override async Task OnInitializedAsync()
    {
        await Initial();
    }

    private async Task Initial()
    {
        projecthd = await pj.GetProjectHDbyID(id);
        customer = Newtonsoft.Json.JsonConvert.DeserializeObject<List<Customer>>(projecthd.CustomerInfo);
        listcontact = Newtonsoft.Json.JsonConvert.DeserializeObject<List<CustomContact>>(projecthd.ContactInfo);
        GetDataAuthen();
        StateHasChanged();
    }

    async Task GetDataAuthen()
    {
        usermemberno = string.Empty;

        AuthenticationState authenticationState;
        authenticationState = await authenticationStateTask;
        this.AuthenticationStateUser = authenticationState.User;
        var claim = this.AuthenticationStateUser.Claims.ToList();
        userrole = int.Parse(claim[1].Value);
        usermemberno = claim[2].Value;
        userid = int.Parse(claim[3].Value);
    }

    async void SaveContact() //Add contact to Project HD
    {
        if (string.IsNullOrEmpty(contactname))
        {
            await ErrorMessage("Please fill in Contact Name!");
            return;
        }
        if (string.IsNullOrEmpty(contactemail))
        {
            await ErrorMessage("Please fill in Contact Email!");
            return;
        }
        if (string.IsNullOrEmpty(contactmobile))
        {
            await ErrorMessage("Please fill in Contact Mobile!");
            return;
        }

        listcontact.Add(new CustomContact()
                {
                    Name = contactname,
                    Position = contactpos,
                    Address = contactaddr,
                    Email = contactemail,
                    MobileNo = contactmobile,
                    Other = contactother
                });

        contactname = string.Empty;
        contactpos = string.Empty;
        contactaddr = string.Empty;
        contactemail = string.Empty;
        contactmobile = string.Empty;
        contactother = string.Empty;
    }

    async void UpdateProjectHD()
    {
        if (string.IsNullOrEmpty(projecthd.ProjectName))
        {
            await ErrorMessage("Please fill in Main Project Name!");
            return;
        }
        if (listcontact is null || listcontact.Count == 0)
        {
            await ErrorMessage("Please fill Contact!");
            return;
        }

        if (customerid > 0)
        {
            List<Customer> customersave = new List<Customer>();
            var result = custommember.Where(c => c.Id == customerid).FirstOrDefault();
            customersave.Add(new Customer()
            {
                Id = result.Id,
                CreateDate = result.CreateDate,
                CustomerId = result.CustomerId,
                Name = result.Name,
                MemberNo = result.MemberNo,
                CompanyName = result.CompanyName,
                Telephone = result.Telephone,
                Email = result.Email,
                LineId = result.LineId    
            });
            projecthd.CustomerInfo = Newtonsoft.Json.JsonConvert.SerializeObject(customersave);
            projecthd.CustomerId = result.Id;
        }

        projecthd.ContactInfo = Newtonsoft.Json.JsonConvert.SerializeObject(listcontact);
        projecthd.ProjectHdstatus = "Open";
        projecthd.Active = "Y";
        projecthd.ProjectHdhistories.Add(new ProjectHdhistory() { ProjectHdid = projecthd.Id, Remark = "Update", EditorId = userid });
        var update = await pj.SaveProjectHD(projecthd);

        NavManager.NavigateTo("/Data/ProjectDetail/" + id);
    }

    void OnTodayPlanStart()
    {
        projecthd.PlanStartDate = DateTime.Now;
    }

    void OnTodayPlanFinish()
    {
        projecthd.PlanFinishDate = DateTime.Now;
    }

    async Task OnLoadData(LoadDataArgs args)
    {
        if (args.Filter.Length <= 2)
        {
            if (custommember is not null)
            {
                custommember.Clear();
            }
        }
        if (args.Filter.Length > 2)
        {
            custommember = await pj.GetCustomerByContain(args.Filter.ToUpper().ToString());
            InvokeAsync(StateHasChanged);
        }
    }

    async Task GetMemberID(object value)
    {
        if (custommember is not null)
        {
            var select = custommember.Where(c => c.CompanyName.ToUpper() == value.ToString().ToUpper()).ToList();
            if (select.Count == 1)
            {
                customerid = select[0].Id;
            }
        }
    }

    async Task ErrorMessage(string message)
    {
        await DialogService.OpenAsync("Warning", ds =>
            @<div>
                @message
            </div>
            , new DialogOptions() { CloseDialogOnOverlayClick = true });
    }

    public void Dispose()
    {
        if (listcontact is not null) listcontact.Clear();
        if (customer is not null) customer.Clear();
        if (custommember is not null) custommember.Clear();
        Console.WriteLine("Disconnected");
    }
}
