@page "/Data/ProjectCreate"

@using ModelM2s;
@using ModelM4s;
@using Data;
@using System.IO

@inject IWebHostEnvironment env
@inject ProjectData pj;
@inject NavigationManager NavManager

<h3>Create New Project</h3>

@*Create Project HD*@
<EditForm Model="formmain">
    &nbsp;<label>Main Project Name :</label> &nbsp; <InputText id="MainName" @bind-Value="formmain.ProjectName"></InputText><br /><br />
    &nbsp;<label>Description :</label> &nbsp; <InputText id="MainDesc" @bind-Value="formmain.Description"></InputText><br /><br />
    &nbsp;<label>Remarked :</label> &nbsp; <InputText id="MainRemark" @bind-Value="formmain.Remark"></InputText><br /><br />
    &nbsp;<label>Customer Infomation :</label> &nbsp; <InputSelect id="MainCustomer" @bind-Value="customerid" @onclick="GetContact">
        <option value="0">------------Select Customer------------</option>
        @if (member is not null)
        {
            foreach (var list in member)
            {
                <option value="@list.Id">@list.CompanyNameEn (@list.CompanyNameTh)</option>
            }
        }
    </InputSelect><br /><br />
    <p style="background-color:white; border:solid">
        &nbsp;<h4>Contact Infomation</h4>
        <table style="width:100%">
            <tr>
                <th>Thai Name</th>
                <th>English Name</th>
                <th>Tel.</th>
                <th>Delete</th>
            </tr>
            @if (ListContact is not null)
            {
                foreach (var list in ListContact)
                {
                    <tr>
                        <td>@list.Title @list.FirstNameTh @list.LastNameTh</td>
                        <td>@list.FirstNameEn @list.LastNameEn</td>
                        <td>@list.MobileNo</td>
                        <td>
                            <button @onclick="() => ListContact.Remove(list)">
                                X
                            </button>
                        </td>
                    </tr>
                }
            }

        </table>
        <div>
            <InputSelect id="MainContact" @bind-Value="contactid">
                <option value="0">------------Select Contact------------</option>
                @if (contact is not null)
                {
                    foreach (var list in contact)
                    {
                        <option value="@list.Id">@list.FirstNameTh @list.LastNameTh</option>
                    }
                }
            </InputSelect> &nbsp;&nbsp;
            <button @onclick="()=>SaveContact(contactid)">Add Contact</button><br /><br />
        </div>
    </p>

    &nbsp;<label>Budget :</label> &nbsp; <InputNumber id="MainBudget" @bind-Value="formmain.Budget"></InputNumber> THB <br /><br />
    &nbsp;<label>Started Date :</label> &nbsp; <InputDate id="MainStartDate" @bind-Value="formmain.PlanStartDate"></InputDate> &nbsp;&nbsp;&nbsp;
    &nbsp;<label>Finished Date :</label> &nbsp; <InputDate id="MainFinishDate" @bind-Value="formmain.PlanFinishDate"></InputDate><br /><br />
    &nbsp;
    @if(MainSaveshow)
    {
        <button @onclick="SaveProjectMain">Next</button>
    }
    
</EditForm>

@*Create Project Sub*@
@if (Subshow)
{
    if (formmain.ProjectSubProjectTls is not null)
    {
        foreach (var sub in formmain.ProjectSubProjectTls)
        {
            <p style="background-color:white; border:solid">
                <button style="align-items:end" @onclick="() => formmain.ProjectSubProjectTls.Remove(sub)">Delete</button><br />
                &nbsp;<label>Project Sub Running No. : @sub.ProjectSubRunNo</label><br /><br />
                &nbsp;<label>Project Sub Name : @sub.ProjectSubName</label><br /><br />
                &nbsp;<label>Description : @sub.Description</label> <br /><br />
                &nbsp;<label>Remarked : @sub.Remark</label> <br /><br />
                &nbsp;<label>Budget : @sub.Budget</label> <br /><br />
                &nbsp;<label>Started Date : @sub.PlanStartDate</label> &nbsp;&nbsp;&nbsp;
                &nbsp;<label>Finished Date : @sub.PlanFinishDate</label> <br /><br />
                &nbsp;
                @foreach (var list in @sub.ProjectRatypeTls)
                {
                    var ra = ratype.Where(w => w.Id == list.RatypeMasterId).FirstOrDefault();
                    <label>RA Type : @ra.Name</label> <br />
                    <label>Category</label>
                    <br />
                    @if (list.MemberCapability is not null)
                    {
                        ShowCategory(list.MemberCapability);
                        if(showcate is not null)
                        {
                            <table style="width:100%">
                                @foreach (var categorylist in showcate)
                                {
                                    var cate = category.Where(w => w.Id == categorylist.CategoryCatId).FirstOrDefault();
                                    <tr>
                                        <td>@cate.CategoryCat - @categorylist.CategoryCatSub</td>
                                    </tr>
                                }
                            </table>
                        }
                    }
                }
                &nbsp;
                @foreach (var file in sub.ProjectDocuments)
                {
                    if (file.DocumentPath.ToUpper().Contains("PDFFILES"))
                    {
                        <a href="@file.DocumentPath">Link</a>
                    }
                    else
                    {
                        <img src="@file.DocumentPath" width="300px" />
                    }
                    <br />
                }
            </p>

        }
    }

    <EditForm Model="formsub">
        <h4>Create Project Sub</h4>
        <p style="background-color:white; border:solid">
            <br />
            &nbsp;<label>Project Sub Name :</label> &nbsp; <InputText id="SubName" @bind-Value="formsub.ProjectSubName"></InputText><br /><br />
            &nbsp;<label>Description :</label> &nbsp; <InputText id="SubDesc" @bind-Value="formsub.Description"></InputText><br /><br />
            &nbsp;<label>Remarked :</label> &nbsp; <InputText id="SubRemark" @bind-Value="formsub.Remark"></InputText><br /><br />
            &nbsp;<label>Budget :</label> &nbsp; <InputNumber id="SubBudget" @bind-Value="formsub.Budget"></InputNumber> THB <br /><br />
            &nbsp;<label>Started Date :</label> &nbsp; <InputDate id="SubStartDate" @bind-Value="formsub.PlanStartDate"></InputDate> &nbsp;&nbsp;&nbsp;
            &nbsp;<label>Finished Date :</label> &nbsp; <InputDate id="SubFinishDate" @bind-Value="formsub.PlanFinishDate"></InputDate>&nbsp;&nbsp;<br /><br />

            &nbsp;<label>RA Type :</label> &nbsp; <InputSelect id="SubRAType" @bind-Value="formRAType.RatypeMasterId">
                <option value="0">------------Select RA Type------------</option>
                @if (ratype is not null)
                {
                    foreach (var list in ratype)
                    {
                        <option value="@list.Id">@list.Name</option>
                    }
                }
            </InputSelect><br /><br />


        <p style="background-color:white; border:solid">
            &nbsp;<h4>Capability</h4>
            <table style="width:100%">
                <tr>
                    <th>Capability</th>
                    <th>Capability Sub</th>
                    <th>Delete</th>
                </tr>
                    @if (ListCategory is not null)
                    {
                        foreach (var list in ListCategory)
                        {
                            var cate = category.Where(w => w.Id == list.CategoryCatId).FirstOrDefault();
                            <tr>
                            <td>@cate.CategoryCat</td>
                            <td>@list.CategoryCatSub</td>
                            <td>
                                <button @onclick="() => ListCategory.Remove(list)">X</button>
                            </td>
                        </tr>
                        }
                    }
            </table>
            <div>
                <InputSelect id="SubCategory" @bind-Value="categoryid">
                    <option value="0">------------Select Category------------</option>
                        @if (category is not null)
                        {
                            foreach (var list in category)
                            {
                                foreach (var sub in list.MasterCapabilityCatSubs)
                                {
                                    <option value="@sub.Id">@list.CategoryCat - @sub.CategoryCatSub</option>
                                }
                            }
                        }
                </InputSelect> &nbsp;&nbsp;
                <button @onclick="()=>SaveCategory(categoryid)">Add Category</button><br /><br />
            </div>
        </p>
        &nbsp;<InputFile OnChange="OnInputFileChange" />
        <br /><br />
        @if (uploadfile)
        {
            <button type="submit" @onclick="OnSubmit">Upload Selected File</button>
        }        
        <br /><br />
        &nbsp;<button @onclick="SaveProjectSub">Add</button>
        </p>
    </EditForm>
    <p>
        &nbsp;<button @onclick="SaveAll">Save All</button>
    </p>
    
}

@code {
    public ProjectHd formmain { get; set; } = new ProjectHd();
    public ProjectSubProjectTl formsub { get; set; } = new ProjectSubProjectTl();
    public ProjectRatypeTl formRAType { get; set; } = new ProjectRatypeTl();
    public List<MemberContactPerson> ListContact { get; set; } = new List<MemberContactPerson>();
    public List<MasterCapabilityCatSub> ListCategory { get; set; } = new List<MasterCapabilityCatSub>();
    public List<MemberMaster> Memberdata { get; set; } = new List<MemberMaster>();
    public List<ProjectHdhistory> HDhis { get; set; } = new List<ProjectHdhistory>();
    public List<ProjectSubProjectTlhistory> Subhis { get; set; } = new List<ProjectSubProjectTlhistory>();

    private List<MemberContactPerson> contact;
    private List<MemberContactPerson> allcontact;
    private List<MasterCapabilityCat> category;
    private List<MasterCapabilityCat> sortedcategory;
    private List<RatypeMaster> ratype;
    private List<MemberMaster> member;
    private List<MasterCapabilityCatSub> showcate;

    int customerid;
    int contactid;
    int categoryid;

    private bool Subshow = false;
    private bool MainSaveshow = true;
    private bool uploadfile = true;

    string Message = "No file selected";
    IBrowserFile selectedFile;

    protected override async Task OnInitializedAsync()
    {
        ratype = await pj.GetRAType();
        member = await pj.GetAllMember();
        category = await pj.GetAllCapability();
        allcontact = await pj.GetAllContact();
        StateHasChanged();
    }

    async void GetContact()
    {
        if (customerid > 0)
        {
            //var membercontact = member.Where(w => w.Id == customerid).FirstOrDefault();
            //contact = await pj.GetContactByMemberNo(membercontact.MemberNo);
            contact = allcontact.Where(w => w.Id == customerid).ToList();
            StateHasChanged();
        }
    }

    void SaveContact(int id) //Add contact to Project HD 
    {
        var result = contact.Where(w => w.Id == id).FirstOrDefault();
        ListContact.Add(new MemberContactPerson() { 
            Id = result.Id,
            MemberNo = result.MemberNo,
            Title = result.Title,
            FirstNameTh = result.FirstNameTh,
            LastNameTh = result.LastNameTh,
            FirstNameEn = result.FirstNameEn,
            LastNameEn = result.LastNameEn,
            Nationality = result.Nationality,
            Position = result.Position,
            PhoneNo = result.PhoneNo,
            MobileNo = result.MobileNo,
            Email = result.Email,
            LineId = result.LineId,
            FaceBook = result.FaceBook,
            Linkedin = result.Linkedin,
            IsOwner = result.IsOwner,
            ShareBaht = result.ShareBaht,
            ShaerPercent = result.ShaerPercent
        });
    }

    void SaveCategory(int id) //Add category to Project Sub
    {
        foreach (var cate in category)
        {
            var sorted = cate.MasterCapabilityCatSubs.Where(w => w.Id == id).FirstOrDefault();
            if (sorted is not null)
            {
                ListCategory.Add(new MasterCapabilityCatSub() { Id = sorted.Id, CategoryCatId = sorted.CategoryCatId, CategoryCatSub = sorted.CategoryCatSub });
                return;
            }
        }
    }

    void SaveProjectMain() //Add data to Project HD List<>
    {
        HDSave();
        Memberdata = new List<MemberMaster>();
        var result = member.Where(c => c.Id == customerid).FirstOrDefault();
        Memberdata.Add(new MemberMaster()
            {
            Id = result.Id,
            CreateDate = result.CreateDate,
            MemberNo = result.MemberNo,
            MemberType = result.MemberType,
            CompanyNameTh = result.CompanyNameTh,
            CompanyNameEn = result.CompanyNameEn,
            CompanyRegistrationNo = result.CompanyRegistrationNo,
            RegisterCapital = result.RegisterCapital,
            ThaiCapitalPercentage = result.ThaiCapitalPercentage,
            EstablishYear = result.EstablishYear,
            FixedAsset = result.FixedAsset,
            NumberofEmployee = result.NumberofEmployee,
            Telephone = result.Telephone,
            Email = result.Email,
            WebSite = result.WebSite,
            Facebook = result.Facebook,
            IsBoi = result.IsBoi,
            IsCoreMemeber = result.IsCoreMemeber,
            IsEnable = result.IsEnable,
            ExpiredDate = result.ExpiredDate
        });
        formmain.CustomerInfo = Newtonsoft.Json.JsonConvert.SerializeObject(Memberdata);
        formmain.ContactInfo = Newtonsoft.Json.JsonConvert.SerializeObject(ListContact);
        formmain.ProjectHdstatus = "Open";
        formmain.Active = "Y";
        formmain.ProjectHdhistories.Add(new ProjectHdhistory() { ProjectHdid = formmain.Id, Remark = "Create", EditorId = 1});
        formsub.ProjectHdid = formmain.Id;
        
        Showsub();
        formsub.ProjectSubName = formmain.ProjectName;
        formsub.Description = formmain.Description;
        formsub.Remark = formmain.Remark;
        formsub.Budget = formmain.Budget;
        formsub.PlanStartDate = formmain.PlanStartDate;
        formsub.PlanFinishDate = formmain.PlanFinishDate;
    }

    void SaveProjectSub() //Add data to Project Sub List<>
    {
        formRAType.MemberCapability = Newtonsoft.Json.JsonConvert.SerializeObject(ListCategory);
        formsub.ProjectRatypeTls.Add(formRAType);
        formsub.ProjectSubStatus = "Open";
        formsub.Active = "Y";
        formsub.ProjectSubProjectTlhistories.Add(new ProjectSubProjectTlhistory() { ProjectSubProjectTlid = formsub.Id, Remark = "Create", EditorId = 1});
        formmain.ProjectSubProjectTls.Add(formsub);

        formsub = new ProjectSubProjectTl();
        formsub.ProjectHdid = formmain.Id;
        ListCategory = new List<MasterCapabilityCatSub>();

        uploadfile = true;
        this.StateHasChanged();
    }

    async void SaveAll()
    {
        var result = await pj.SaveProjectHD(formmain);
        NavManager.NavigateTo("/Data/Project");
    }

    private void ShowCategory(string cate) //Get category from Project Sub List<> to json format and show in page
    {
        showcate = new List<MasterCapabilityCatSub>();
        showcate = Newtonsoft.Json.JsonConvert.DeserializeObject<List<MasterCapabilityCatSub>>(cate);
    }

    private void Showsub() //After click next in Project HD show  Project sub area
    {
        Subshow = true;
    }

    private void HDSave() //After click next in Project HD hide button
    {
        MainSaveshow = false;
    }

    private void OnInputFileChange(InputFileChangeEventArgs e)
    {
        selectedFile = e.GetMultipleFiles()[0];
        Message = $"{selectedFile.Name} ({selectedFile.Size} bytes) file selected";
        this.StateHasChanged();
    }

    private async void OnSubmit() //Upload file (image,pdf) to local folders
    {
        if (selectedFile != null)
        {
            Stream stream = selectedFile.OpenReadStream(maxAllowedSize: 1024 * 1024 * 100);
            string filename = formsub.ProjectSubRunNo + "_" + selectedFile.Name;
            string filetype = string.Empty;
            string filepath = string.Empty;
            if (selectedFile.Name.ToUpper().Contains("PDF"))
            {
                filetype = "\\PDFFiles\\" + filename;
                filepath = "/PDFFiles/" + filename;
            }
            else
            {
                filetype = "\\PicFiles\\" + filename;
                filepath = "/PicFiles/" + filename;
            }
            var path = $"{env.WebRootPath}{filetype}";
            FileStream fs = File.Create(path);
            await stream.CopyToAsync(fs);
            stream.Close();
            fs.Close();

            formsub.ProjectDocuments.Add(new ProjectDocument() { ProjectSubProjectTlid = formsub.Id, DocumentPath = filepath, Active = "Y", EditorId = 1 });
        }

        uploadfile = false;
        this.StateHasChanged();
    } 
}
